kind: pipeline
type: docker
name: default

steps:
- name: build_docker
  image: docker
  volumes:
  - name: dockersock
    path: /var/run/docker.sock
  commands:
  - docker build -t cppbuild .

- name: test
  image: cppbuild
  pull: if-not-exists
  commands:
  - mkdir build
  - cd build
  - cmake -Dpoaky_build_tests=ON -Dpoaky_build_coverage ..
  - make poaky_test
  - ./bin/poaky_test
  - make poaky_coverage_report
  - cd ..
  - chmod +x codecov.sh
  - ./codecov.sh -t ${CODECOV_TOKEN} -f build/poaky_coverage_report.info ||
    echo "Codecov did not collect coverage reports."
  environment:
    CODECOV_TOKEN:
      from_secret: codecov_token

volumes:
- name: dockersock
  host:
    path: /var/run/docker.sock
